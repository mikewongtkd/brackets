<html>
	<head>
		<link href="include/fontawesome/css/font-awesome.min.css" rel="stylesheet" />
		<link href="include/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
		<link href="include/bootstrap/add-ons/editable/css/bootstrap-editable.css" rel="stylesheet" />
		<link href="include/codemirror/lib/codemirror.css" rel="stylesheet" />
		<link href="include/alertify/css/alertify.min.css" rel="stylesheet" />
		<link href="include/alertify/css/themes/default.min.css" rel="stylesheet" />
		<link href="include/brackets/css/brackets.css" rel="stylesheet" />
		<script src="include/svg/svg.min.js"></script>
		<script src="include/jquery/js/jquery.min.js"></script>
		<script src="include/jquery/js/jquery-ui.min.js"></script>
		<script src="include/bootstrap/js/bootstrap.min.js"></script>
		<script src="include/bootstrap/add-ons/editable/js/bootstrap-editable.min.js"></script>
		<script src="include/brackets/js/freescore.js"></script>
		<script src="include/brackets/js/score.class.js"></script>
		<script src="include/brackets/js/athlete.class.js"></script>
		<script src="include/brackets/js/division.class.js"></script>
		<script src="include/brackets/js/brackets.js"></script>
		<script src="include/codemirror/lib/codemirror.js"></script>
	</head>
	<body>
		<div class="page-header">
			<div class="container">
				<h1 id="division-description">Division</h1>
				<div class="brackets" id="brackets"></div> 
				<h4>Athletes</h4>
				<textarea id="athletes" class="panel-body"></textarea>
			</div>
		</div>
		<div class="container">
			
		</div>
		<script>
			var division = { athletes: [], brackets: {} };
			var athletes = { textarea: document.getElementById( 'athletes' ) };

			var _build_brackets = function( brackets, athletes, byes ) {
				byes       = defined( byes ) ? byes : 0;
				var num    = { athletes: athletes.length, byes: { a: 0, b: 0 }};
				var total  = num.athletes + byes;
				var depth  = Math.ceil( Math.log( total )/Math.log( 2 ));
				var size   = { round: Math.pow( 2, depth ) };

				size.group = size.round / 2;
				num.a      = Math.ceil( num.athletes / 2 );
				num.b      = num.athletes - num.a;
				num.byes.a = size.group - num.a;
				num.byes.b = size.group - num.b;

				console.log( brackets, athletes, num, size );

				a = athletes.splice( 0, num.a );
				b = athletes;

				if( size.group <= 1 ) {
					var blue = a[ 0 ];
					var bye  = b.length > 0 ? undefined : 1;
					var red  = b.length > 0 ? b[ 0 ] : undefined;
					var bracket = bye ? 
					{
						blue: { athlete: blue,       score: 0 },
						red:  { athlete: undefined,  score: 0 },
					} : {
						blue: { athlete: blue,       score: 0 },
						red:  { athlete: red,        score: 0 },
					}
					brackets[ 0 ].push( bracket );
					return;
				}

				_build_brackets( brackets, a, num.byes.a );
				_build_brackets( brackets, b, num.byes.b );
			};

			$( function() {
				$( '#division-description' ).editable({ 
					type:    'text', 
					title:   'Enter division description', 
					success: function( response, newValue ) {
					
					division.description = newValue;
				}});
				athletes.editor = CodeMirror.fromTextArea( athletes.textarea, { lineNumbers: true });
				athletes.editor.setSize( '100%', '480' );
				athletes.editor.on( 'keydown', function( cm, ev ) { 
					if( ev.key == 'Enter' ) {
						var list  = { text : cm.getValue() };
						var names = list.text.split( /\n/ );
						names.forEach( function( name, i ) { division.athletes.push({ name: name }); });

						division.brackets = [[]];
						athletes.indexes = division.athletes.map( function( athlete, i ) { return i; });
						_build_brackets( division.brackets, athletes.indexes );

						$( '#brackets' ).empty();
						$( '#brackets' ).brackets({ division: division });
					}
				});
			});
		</script>
	</body>
</html>
